# BRIDGE Version 2.9.1 - Discount Refresh Fix

**Release Date**: December 2, 2025  
**Priority**: Critical Bug Fix  
**Status**: Production Ready

---

## The Problem

After applying discounts to products, the **discount percentage column was not updating** in the UI, even though the prices were updating successfully in WooCommerce. This made it impossible to verify if discounts were actually applied without manually refreshing the entire data.

### User Impact
- Applied discount but column still showed old percentage (e.g., 0% instead of 10%)
- Had to manually re-fetch all data to see updated discounts
- Couldn't verify discount changes in real-time
- Confusion about whether discount was actually applied

---

## Root Causes

### Issue 1: Wrong Field Name
In the `update_woo_product_from_api` function (line 174), the recalculated discount was being saved to a field called `discount` instead of `woo_discount_percent`.

**Before:**
```python
self.matched_products[i]['discount'] = round(discount, 2)  # WRONG FIELD
```

**After:**
```python
self.matched_products[i]['woo_discount_percent'] = discount_percent  # CORRECT
```

### Issue 2: Wrong Endpoint for Variations
The `refresh_from_woocommerce` function was using `/products/{id}` for all products, but variations need `/products/{parent_id}/variations/{id}`. This caused refresh to fail silently for variations.

**Before:**
```python
url = f"{store_url}/wp-json/wc/v3/products/{product_id}"  # WRONG FOR VARIATIONS
```

**After:**
```python
if parent_id:
    # This is a variation
    url = f"{store_url}/wp-json/wc/v3/products/{parent_id}/variations/{product_id}"
else:
    # This is a regular product
    url = f"{store_url}/wp-json/wc/v3/products/{product_id}"
```

---

## What's Fixed

### Now Working Correctly
1. ✅ Discount percentage updates immediately after applying discounts
2. ✅ Works for both regular products and variations
3. ✅ No need to manually refresh entire dataset
4. ✅ Real-time visual feedback on discount changes
5. ✅ Consistent field naming throughout application

### Technical Changes
- **Line 173**: Fixed discount calculation formula to match ProductMatcher
- **Line 174**: Changed field name from `discount` to `woo_discount_percent`
- **Lines 1655-1665**: Added parent_id check for correct variation endpoint

---

## How to Update

```bash
cd /path/to/bridge
git pull origin master
```

No configuration changes needed. Launch BRIDGE normally.

---

## Testing the Fix

### Test 1: Apply Discount to Regular Product
1. Select a regular product
2. Apply a discount (e.g., 10%)
3. **Verify**: Discount column immediately shows "10.0%"

### Test 2: Apply Discount to Variation
1. Enable "Fetch Variations" and fetch data
2. Select a variation product (e.g., GVS brand)
3. Apply a discount (e.g., 15%)
4. **Verify**: Discount column immediately shows "15.0%"

### Test 3: Change Discount
1. Select a product with existing discount (e.g., 10%)
2. Apply a different discount (e.g., 20%)
3. **Verify**: Discount column updates from "10.0%" to "20.0%"

### Test 4: Remove Discount
1. Select a product with discount
2. Sync to Capital prices (which clears sale_price)
3. **Verify**: Discount column shows "0.0%"

---

## Before vs After

| Scenario | v2.9 (Before) | v2.9.1 (After) |
|----------|---------------|----------------|
| Apply 10% discount | Shows 0% | Shows 10% ✅ |
| Change 10% to 20% | Shows 10% | Shows 20% ✅ |
| Remove discount | Shows old % | Shows 0% ✅ |
| Variation discount | Shows 0% | Shows correct % ✅ |
| Need to verify | Re-fetch all data | Instant feedback ✅ |

---

## What You'll See

### Success Indicators
After applying a discount, you should see:
1. **Logs tab**: "Applying X% discount to {SKU}"
2. **Logs tab**: "Refreshed product {SKU} from WooCommerce"
3. **Products/Prices tab**: Discount column updates to "X.X%"
4. **Sale Price column**: Shows calculated sale price

### Example Flow
```
User: Apply 15% discount to product ABC123
↓
[Logs] Applying 15% discount to ABC123: sale_price=85.00
[Logs] Updated product/variation 12345
[Logs] Refreshed product ABC123 from WooCommerce
↓
UI: Discount column changes from "0.0%" to "15.0%"
UI: Sale Price column shows "€85.00"
```

---

## Technical Details

### Discount Calculation Formula
```python
if regular_price > 0 and sale_price > 0:
    discount_percent = round((1 - sale_price / regular_price) * 100, 2)
else:
    discount_percent = 0
```

This formula is now consistent across:
- ProductMatcher (initial product matching)
- update_woo_product_from_api (after refresh)
- All display functions

### Field Naming Convention
All discount-related fields now use `woo_discount_percent`:
- In matched_products dictionary
- In update_woo_product_from_api
- In all display functions (Products tab, Prices tab)

---

## Related Fixes

This fix complements the v2.9 variation update fix:
- **v2.9**: Fixed variation updates not persisting
- **v2.9.1**: Fixed discount display not refreshing

Together, these ensure:
1. Variations update correctly (v2.9)
2. Updates refresh correctly (v2.9.1)
3. Discount percentages display correctly (v2.9.1)

---

## Troubleshooting

### Issue: Discount still not updating
**Check**:
1. Did you pull latest code? (`git pull origin master`)
2. Did you restart BRIDGE application?
3. Is the product actually updating? (check WooCommerce admin)

**Solution**: Verify git log shows commit 4afbffe

### Issue: Discount shows wrong percentage
**Check**:
1. Is regular_price set correctly?
2. Is sale_price set correctly?
3. Check logs for "Refreshed product" message

**Solution**: If refresh failed, check WooCommerce API credentials

---

## Files Changed

- `bridge_app.py`:
  - Line 173: Fixed discount calculation
  - Line 174: Fixed field name
  - Lines 1655-1665: Fixed variation refresh endpoint

---

## Key Takeaways

1. **Instant feedback** - No more guessing if discount applied
2. **Works everywhere** - Regular products and variations
3. **No manual refresh** - System refreshes automatically
4. **Consistent naming** - All fields use woo_discount_percent

---

**Version**: 2.9.1  
**Commit**: 4afbffe  
**Repository**: https://github.com/geosampson/bridge  
**Date**: December 2, 2025

---

**Now you can see your discount changes in real-time!** ✅
